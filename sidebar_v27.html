<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      :root {
        --primary-bg: #f5f5f5;
        --secondary-bg: #ffffff;
        --accent-color: #1a73e8;
        --accent-hover: #1557b0;
        --text-color: #202124;
        --text-secondary: #5f6368;
        --border-color: #dadce0;
        --success-color: #188038;
        --error-color: #d93025;
        --warning-color: #f9ab00;
        --shadow: 0 1px 3px rgba(60,64,67,0.3);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 16px;
        background-color: var(--primary-bg);
        color: var(--text-color);
        font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        font-size: 14px;
        line-height: 1.5;
      }
      .card {
        background-color: var(--secondary-bg);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 1px 2px rgba(60,64,67,0.15);
      }
      .card-title {
        margin: 0 0 12px;
        font-size: 16px;
        font-weight: 500;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card-title::before {
        content: '';
        width: 4px;
        height: 20px;
        background-color: var(--accent-color);
        border-radius: 2px;
      }
      .input-group {
        margin-bottom: 12px;
      }
      .input-row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      .input-group.half {
        flex: 1;
        margin-bottom: 0;
      }
      .input-label {
        display: block;
        margin-bottom: 4px;
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 500;
      }
      input[type="text"] {
        width: 100%;
        padding: 8px 12px;
        font-size: 14px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--secondary-bg);
        color: var(--text-color);
        transition: border-color 0.2s;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: var(--accent-color);
      }
      input[type="text"]:hover {
        border-color: var(--text-secondary);
      }
      .button-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .button-group.inline {
        display: inline-flex;
        width: 100%;
      }
      button {
        background-color: var(--accent-color);
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        color: #ffffff;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
        min-width: 80px;
      }
      button:hover {
        background-color: var(--accent-hover);
        box-shadow: var(--shadow);
      }
      button:active {
        transform: translateY(1px);
      }
      button:disabled {
        background-color: #e8eaed;
        color: #80868b;
        cursor: not-allowed;
        box-shadow: none;
      }
      button.secondary {
        background-color: var(--secondary-bg);
        color: var(--accent-color);
        border: 1px solid var(--border-color);
      }
      button.secondary:hover {
        background-color: #f8f9fa;
        border-color: var(--accent-color);
      }
      button.full-width {
        width: 100%;
        flex: unset;
      }
      #toast {
        margin-top: 12px;
        padding: 12px;
        background-color: var(--secondary-bg);
        border-left: 4px solid var(--accent-color);
        border-radius: 4px;
        font-size: 13px;
        box-shadow: 0 1px 2px rgba(60,64,67,0.1);
      }
      #toast.success {
        border-left-color: var(--success-color);
      }
      #toast.error {
        border-left-color: var(--error-color);
      }
      #logContainer {
        margin-top: 12px;
        padding: 12px;
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 12px;
        border-radius: 4px;
        max-height: 320px;
        overflow-y: auto;
        white-space: pre-wrap;
        display: none;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
      }
      #logContainer.visible {
        display: block;
      }
      #logContainer::-webkit-scrollbar {
        width: 8px;
      }
      #logContainer::-webkit-scrollbar-track {
        background: #2d2d2d;
      }
      #logContainer::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      #logContainer::-webkit-scrollbar-thumb:hover {
        background: #aaa;
      }
      #toggleLogBtn {
        background-color: transparent;
        color: var(--text-secondary);
        font-size: 12px;
        padding: 4px 8px;
        margin-top: 8px;
        border: 1px solid var(--border-color);
        min-width: unset;
      }
      #toggleLogBtn:hover {
        background-color: var(--primary-bg);
        color: var(--text-color);
      }
      .divider {
        height: 1px;
        background-color: var(--border-color);
        margin: 16px 0;
      }
      a {
        color: var(--accent-color);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .processing {
        position: relative;
        overflow: hidden;
      }
      .processing::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }
      .log-success { color: #4ade80; }
      .log-error { color: #f87171; }
      .log-warning { color: #fbbf24; }
      .log-info { color: #60a5fa; }
      .log-header { color: #c084fc; font-weight: bold; }
      
      /* Iconos */
      .icon {
        width: 16px;
        height: 16px;
        display: inline-block;
        vertical-align: text-bottom;
        margin-right: 4px;
      }
      
      /* ‚Äî‚Äî‚Äî‚Äî‚Äî Nuevas reglas para los botones de color ‚Äî‚Äî‚Äî‚Äî‚Äî */
      .color-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }
      .color-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
        cursor: pointer;
        transition: transform 0.2s;
      }
      .color-circle:hover {
        transform: scale(1.2);
      }

      /* Estilos para asignaciones de tareas */
      .designer-item {
        background-color: var(--primary-bg);
        padding: 8px 10px;
        border-radius: 4px;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        border: 1px solid var(--border-color);
      }
      .designer-item .designer-name {
        font-weight: 500;
        flex: 1;
      }
      .designer-item .designer-counts {
        color: var(--text-secondary);
        font-size: 11px;
        margin-right: 8px;
      }
      .designer-item .remove-btn {
        background-color: transparent;
        color: var(--error-color);
        border: none;
        padding: 2px 6px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 3px;
        min-width: unset;
        flex: unset;
      }
      .designer-item .remove-btn:hover {
        background-color: rgba(217, 48, 37, 0.1);
      }
      .topic-tag {
        background-color: var(--accent-color);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .topic-tag .remove-topic {
        cursor: pointer;
        font-weight: bold;
        padding: 0 2px;
        border-radius: 50%;
        line-height: 1;
      }
      .topic-tag .remove-topic:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      input[type="text"].error {
        border-color: var(--error-color);
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h3 class="card-title">üìÅ Cargar Im√°genes</h3>
      <div class="input-group">
        <label class="input-label">ID de la carpeta de Drive</label>
        <input type="text" id="folderId" placeholder="Ejemplo: 1KMk9sU3OvPDdmKrWJNLsC_Jtm6vpcbN8">
      </div>
      <div class="button-group">
        <button id="btnBranded" onclick="runScript()">Cargar Mockups</button>
      </div>
    </div>
 
     <div class="card">   
          <!-- ‚Äî‚Äî‚Äî Botones circulares de correcci√≥n ‚Äî‚Äî‚Äî -->
      <div class="color-buttons">
        <div class="color-circle" style="background-color: #00FF00;"
             title="Borde Verde" onclick="runGreenBorder()"></div>
        <div class="color-circle" style="background-color: #FFFF00;"
             title="Borde Amarillo" onclick="runYellowBorder()"></div>
        <div class="color-circle" style="background-color: #FF0000;"
             title="Borde Rojo" onclick="runRedBorder()"></div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">üî¢ Numerar</h3>
      <div class="input-row">
        <div class="input-group half">
          <label class="input-label">N√∫mero inicial</label>
          <input type="text" id="labelStart" placeholder="1">
        </div>
        <div class="input-group half">
          <label class="input-label">Formato</label>
          <input type="text" id="labelFormat" placeholder="UBA #" value="UBA #">
        </div>
      </div>
      <button id="btnLabel" onclick="runLabelling()" class="full-width">Numerar Selecci√≥n</button>
    </div>
    
    <div class="card">
      <h3 class="card-title">üîÑ Crear √çndice</h3>
      <p style="font-size: 12px; color: var(--text-secondary); margin: 8px 0;">
        Genera √≠ndice autom√°tico desde UBAs existentes.
      </p>
      
      <div class="button-group" style="margin-bottom: 12px;">
        <button onclick="runGenerateIndex()" class="full-width">üîß Generar √çndice</button>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">üíæ Descargar Im√°genes</h3>
      <div class="button-group inline">
        <button id="btnDownloadSel" onclick="runDownloadImages()">Selecci√≥n</button>
        <button id="btnDownloadAll" onclick="runDownloadAllImages()">Todas</button>
      </div>
    </div>
    <div class="card">
      <h3 class="card-title">üéØ SafeZone Overlay</h3>
      <button id="btnSafezone" onclick="runSafezone()" class="full-width">Toggle SafeZone</button>
    </div>

    <!-- Nueva secci√≥n de Asignaciones de Tareas -->
    <div class="card">
      <h3 class="card-title">üìã Asignaciones de Tareas</h3>

      <!-- Dise√±adores -->
      <div style="margin-bottom: 16px;">
        <label class="input-label">Dise√±adores</label>
        <div id="designersList" style="margin-bottom: 8px; max-height: 150px; overflow-y: auto;"></div>
        <div class="input-row">
          <input type="text" id="designerName" placeholder="Nombre del dise√±ador" style="flex: 1;">
          <button onclick="addDesigner()" class="secondary" style="flex: 0 0 auto; padding: 8px 12px;">+ Agregar</button>
        </div>
      </div>

      <!-- Piezas por dise√±ador -->
      <div style="margin-bottom: 16px;">
        <label class="input-label">¬øCu√°ntas piezas hace cada dise√±ador? (m√°ximo)</label>
        <input type="number" id="piecesPerDesigner" placeholder="0" value="0" min="1" style="text-align: center;">
        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
          Las categor√≠as se distribuir√°n correlativamente hasta este l√≠mite
        </div>
      </div>

      <!-- Categor√≠as -->
      <div style="margin-bottom: 16px;">
        <label class="input-label">Categor√≠as (ej: 1, 2a, 2b, 3...)</label>
        <div id="categoriesList" style="margin-bottom: 8px; max-height: 120px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 4px;"></div>
        <div class="input-row">
          <input type="text" id="categoryInput" placeholder="Categor√≠a (ej: 1a)" style="flex: 1;">
          <button onclick="addCategory()" class="secondary" style="flex: 0 0 auto;">+ Agregar</button>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 4px;">
          <button onclick="autoNumberCategories()" class="secondary" style="flex: 1; font-size: 12px;">Auto: 1, 2, 3...</button>
          <button onclick="clearCategories()" class="secondary" style="flex: 1; font-size: 12px;">Limpiar</button>
        </div>
      </div>

      <!-- Cantidad de Stills -->
      <div style="margin-bottom: 16px;">
        <label class="input-label">¬øCu√°ntas piezas son Stills? (primeras N columnas)</label>
        <input type="number" id="stillsCount" placeholder="0" value="0" min="0" style="text-align: center;">
        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
          Las restantes columnas ser√°n Conceptuales
        </div>
      </div>

      <!-- Generar tabla -->
      <button onclick="generateAssignmentTable()" class="full-width">üé® Generar Tabla de Asignaci√≥n</button>
    </div>

    <div class="divider"></div>         
    <div id="toast">Listo para usar</div>
    <button id="toggleLogBtn" onclick="toggleLog()" class="secondary">üìã Ver log detallado</button>
    <div id="logContainer"></div>
    
    <script>
      let isProcessing = false;
      
      function setProcessing(state) {
        isProcessing = state;
        const buttons = document.querySelectorAll('button:not(#toggleLogBtn)');
        buttons.forEach(btn => {
          btn.disabled = state;
          if (state) {
            btn.classList.add('processing');
          } else {
            btn.classList.remove('processing');
          }
        });
      }
      
      function setToastStatus(message, status = 'info') {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.className = '';
        if (status === 'success') {
          toast.classList.add('success');
        } else if (status === 'error') {
          toast.classList.add('error');
        }
      }
      
      function updateLog(logText) {
        const logContainer = document.getElementById('logContainer');
        // Aplicar colores y estilos
        logText = logText.replace(/‚úì/g, '<span class="log-success">‚úì</span>');
        logText = logText.replace(/‚úó/g, '<span class="log-error">‚úó</span>');
        logText = logText.replace(/‚ö†Ô∏è/g, '<span class="log-warning">‚ö†Ô∏è</span>');
        logText = logText.replace(/‚Üí/g, '<span class="log-info">‚Üí</span>');
        logText = logText.replace(/===(.*?)===/g, '<span class="log-header">=== $1 ===</span>');
        logText = logText.replace(/---(.*?)$/gm, '<span class="log-info">--- $1</span>');
        logContainer.innerHTML = logText;
        // Auto-scroll al final
        logContainer.scrollTop = logContainer.scrollHeight;
      }
      
      function toggleLog() {
        const logContainer = document.getElementById('logContainer');
        const toggleBtn = document.getElementById('toggleLogBtn');
        logContainer.classList.toggle('visible');
        if (logContainer.classList.contains('visible')) {
          toggleBtn.innerHTML = 'üìã Ocultar log detallado';
        } else {
          toggleBtn.innerHTML = 'üìã Ver log detallado';
        }
      }
      
      function validateFolderId(folderId) {
        // Verificar que el ID tenga el formato correcto
        if (!folderId || folderId.trim() === '') {
          setToastStatus("‚ö†Ô∏è Por favor ingresa un ID de carpeta", 'error');
          return false;
        }
        
        // Los IDs de Google Drive suelen tener entre 20-40 caracteres alfanum√©ricos
        var cleanId = folderId.trim();
        if (cleanId.length < 20 || cleanId.length > 50) {
          setToastStatus("‚ö†Ô∏è El ID de carpeta parece incorrecto (longitud inv√°lida)", 'error');
          return false;
        }
        
        // Verificar que solo contenga caracteres v√°lidos
        if (!/^[a-zA-Z0-9_-]+$/.test(cleanId)) {
          setToastStatus("‚ö†Ô∏è El ID de carpeta contiene caracteres inv√°lidos", 'error');
          return false;
        }
        
        return true;
      }
      
      function runScript() {
        if (isProcessing) return;
        var folderId = document.getElementById('folderId').value.trim();
        
        if (!validateFolderId(folderId)) {
          document.getElementById('folderId').focus();
          return;
        }
        
        setProcessing(true);
        setToastStatus("‚è≥ Procesando im√°genes Branded...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando proceso Branded...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì Proceso Branded completado exitosamente", 'success');
            } else {
              setToastStatus("‚úó Error en el proceso Branded (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .importImagesInBatch(folderId);
      }
      
      function runScriptUnbranded() {
        if (isProcessing) return;
        var folderId = document.getElementById('folderId').value.trim();
        
        if (!validateFolderId(folderId)) {
          document.getElementById('folderId').focus();
          return;
        }
        
        setProcessing(true);
        setToastStatus("‚è≥ Procesando im√°genes UnBranded...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando proceso UnBranded...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì Proceso UnBranded completado exitosamente", 'success');
            } else {
              setToastStatus("‚úó Error en el proceso UnBranded (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .importImagesInBatchUnbranded(folderId);
      }
      
      function runAVA() {
        if (isProcessing) return;
        var folderId = document.getElementById('folderId').value.trim();
        
        // AVA puede usar carpeta por defecto si no se especifica
        if (folderId && !validateFolderId(folderId)) {
          document.getElementById('folderId').focus();
          return;
        }
        
        setProcessing(true);
        setToastStatus("‚è≥ Procesando AVA Recommendations...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando proceso AVA Recommendations...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì Proceso AVA completado exitosamente", 'success');
            } else {
              setToastStatus("‚úó Error en el proceso AVA (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .avaRecommendations(folderId);
      }
      
      function runLabelling() {
        if (isProcessing) return;
        setProcessing(true);
        var labelStart = document.getElementById('labelStart').value;
        var labelFormat = document.getElementById('labelFormat').value;
        setToastStatus("‚è≥ Numerando elementos...");
        
        google.script.run.withSuccessHandler(function(result){
          setProcessing(false);
          if (typeof result === "number") {
            setToastStatus("‚úì " + result + " elementos numerados", 'success');
          } else {
            setToastStatus(result, result.includes('Error') ? 'error' : 'success');
          }
        }).withFailureHandler(function(error){
          setProcessing(false);
          setToastStatus("‚úó Error: " + error.message, 'error');
        }).labelSequenceCustom(labelStart, labelFormat);
      }
      
      function runGenerateIndex() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Generando √≠ndice autom√°tico desde UBAs...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando generaci√≥n de √≠ndice autom√°tico...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì √çndice autom√°tico generado exitosamente", 'success');
            } else {
              setToastStatus("‚úó Error generando √≠ndice autom√°tico (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .generateIndexFromUBAs();
      }
      
      function runDownloadImages() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Preparando descarga de imagen seleccionada...");
        
        google.script.run.withSuccessHandler(function(result) {
          setProcessing(false);
          if (result.error) {
            setToastStatus("‚úó " + result.error, 'error');
          } else if (Array.isArray(result) && result.length > 0) {
            if (result.length === 1) {
              var a = document.createElement("a");
              a.href = result[0].dataUrl;
              a.download = result[0].fileName;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              setToastStatus("‚úì Descarga completada: " + result[0].fileName, 'success');
            } else {
              var linksHTML = "üì• Descarga las siguientes im√°genes:<br><br>";
              for (var i = 0; i < result.length; i++) {
                linksHTML += '<a href="' + result[i].dataUrl + '" download="' + result[i].fileName + '">' + result[i].fileName + '</a><br>';
              }
              document.getElementById("toast").innerHTML = linksHTML;
            }
          } else {
            setToastStatus("‚ö†Ô∏è No se encontr√≥ ninguna imagen para descargar", 'error');
          }
        }).withFailureHandler(function(error){
          setProcessing(false);
          setToastStatus("‚úó Error: " + error.message, 'error');
        }).downloadSelectedImages();
      }
      
      function runDownloadAllImages() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Preparando descarga de todas las im√°genes...");
        
        google.script.run.withSuccessHandler(function(result) {
          setProcessing(false);
          var output = "";
          if (result.error) {
            setToastStatus("‚úó " + result.error, 'error');
          } else if (result.images && result.images.length > 0) {
            if (result.images.length === 1) {
              var a = document.createElement("a");
              a.href = result.images[0].dataUrl;
              a.download = result.images[0].fileName;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              setToastStatus("‚úì Descarga completada: " + result.images[0].fileName, 'success');
            } else {
              output = "üì• Descarga las siguientes " + result.images.length + " im√°genes:<br><br>";
              for (var i = 0; i < result.images.length; i++) {
                output += '<a href="' + result.images[i].dataUrl + '" download="' + result.images[i].fileName + '">' + result.images[i].fileName + '</a><br>';
              }
              document.getElementById("toast").innerHTML = output;
            }
          } else {
            setToastStatus("‚ö†Ô∏è No se encontraron im√°genes en el slide", 'error');
          }
        }).withFailureHandler(function(error){
          setProcessing(false);
          setToastStatus("‚úó Error: " + error.message, 'error');
        }).debugDownloadAllImagesFromSlide();
      }
      
      function runSafezone() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Procesando SafeZone Overlay...");
        
        google.script.run.withSuccessHandler(function(result){
          setProcessing(false);
          if (result.includes('Error') || result.includes('error')) {
            setToastStatus(result, 'error');
          } else {
            setToastStatus(result, 'success');
          }
        }).withFailureHandler(function(error){
          setProcessing(false);
          setToastStatus("‚úó Error: " + error.message, 'error');
        }).toggleSafezonesOverlay();
      }
      
      // ‚Äî‚Äî‚Äî‚Äî‚Äî Nuevas funciones de los botones de color ‚Äî‚Äî‚Äî‚Äî‚Äî
      function runGreenBorder() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Aplicando borde verde‚Ä¶");
        google.script.run.withSuccessHandler(function(){
          setProcessing(false);
          setToastStatus("‚úì Borde verde aplicado.", "success");
        }).addGreenBorder();
      }
      
      function runYellowBorder() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Aplicando borde amarillo‚Ä¶");
        google.script.run.withSuccessHandler(function(){
          setProcessing(false);
          setToastStatus("‚úì Borde amarillo aplicado.", "success");
        }).addYellowBorder();
      }
      
      function runRedBorder() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Aplicando borde rojo‚Ä¶");
        google.script.run.withSuccessHandler(function(){
          setProcessing(false);
          setToastStatus("‚úì Borde rojo aplicado.", "success");
        }).addRedBorder();
      }
      
      // Resto de las funciones existentes‚Ä¶
      function runDebugLayouts() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Analizando layouts disponibles...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando an√°lisis de layouts...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì An√°lisis de layouts completado", 'success');
            } else {
              setToastStatus("‚úó Error en an√°lisis de layouts (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .debugLayouts();
      }
      
      function runGenerateIndex() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Generando √≠ndice autom√°tico desde UBAs...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando generaci√≥n de √≠ndice autom√°tico...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì √çndice autom√°tico generado exitosamente", 'success');
            } else {
              setToastStatus("‚úó Error generando √≠ndice autom√°tico (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .generateIndexFromUBAs();
      }
      
      function runReorderFromIndex() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Reordenando desde √≠ndice linkeado...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando reordenamiento desde √≠ndice...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì Reordenamiento desde √≠ndice completado", 'success');
            } else {
              setToastStatus("‚úó Error en reordenamiento desde √≠ndice (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .reorderFromLinkedIndex();
      }
      
      function runReorderSlides() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Reordenando slides por √≠ndice (m√©todo cl√°sico)...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando reordenamiento cl√°sico...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì Slides reordenados exitosamente", 'success');
            } else {
              setToastStatus("‚úó Error en el reordenamiento (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .reorderSlidesByIndex();
      }
      
      function runVisualMappingSimple() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Ejecutando mapeo visual simple...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando mapeo visual simple...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì Mapeo visual simple completado", 'success');
            } else {
              setToastStatus("‚úó Error en mapeo visual simple (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .testVisualMappingSimple();
      }
      
      function runVisualMappingAdvanced() {
        if (isProcessing) return;
        setProcessing(true);
        setToastStatus("‚è≥ Ejecutando mapeo visual avanzado...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Iniciando mapeo visual avanzado...");
        
        google.script.run
          .withSuccessHandler(function(result){
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì Mapeo visual avanzado completado", 'success');
            } else {
              setToastStatus("‚úó Error en mapeo visual avanzado (ver log)", 'error');
            }
          })
          .withFailureHandler(function(error){
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .testVisualMappingAdvanced();
      }
      
      // ========== FUNCIONES PARA ASIGNACIONES DE TAREAS ==========

      let designers = [];
      let categories = [];

      function addDesigner() {
        const nameInput = document.getElementById('designerName');
        const name = nameInput.value.trim();

        // Validaciones
        if (!name) {
          nameInput.classList.add('error');
          setToastStatus("‚ö†Ô∏è Ingresa el nombre del dise√±ador", 'error');
          nameInput.focus();
          setTimeout(() => nameInput.classList.remove('error'), 2000);
          return;
        }

        // Verificar que no est√© duplicado
        if (designers.some(d => d.name.toLowerCase() === name.toLowerCase())) {
          nameInput.classList.add('error');
          setToastStatus("‚ö†Ô∏è El dise√±ador '" + name + "' ya existe", 'error');
          setTimeout(() => nameInput.classList.remove('error'), 2000);
          return;
        }

        // Agregar dise√±ador (solo nombre)
        designers.push({ name: name });

        // Limpiar input
        nameInput.value = '';
        nameInput.focus();

        // Actualizar UI
        updateDesignersList();
        setToastStatus("‚úì Dise√±ador agregado: " + name, 'success');
      }

      function removeDesigner(index) {
        const removed = designers.splice(index, 1)[0];
        updateDesignersList();
        setToastStatus("‚úì Dise√±ador eliminado: " + removed.name, 'success');
      }

      function updateDesignersList() {
        const container = document.getElementById('designersList');

        if (designers.length === 0) {
          container.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; padding: 8px;">No hay dise√±adores agregados</div>';
          return;
        }

        container.innerHTML = designers.map((d, index) => {
          return `
            <div class="designer-item">
              <span class="designer-name">${d.name}</span>
              <button class="remove-btn" onclick="removeDesigner(${index})" title="Eliminar">√ó</button>
            </div>
          `;
        }).join('');
      }

      function addCategory() {
        const input = document.getElementById('categoryInput');
        const category = input.value.trim();

        if (!category) {
          input.classList.add('error');
          setToastStatus("‚ö†Ô∏è Ingresa una categor√≠a", 'error');
          setTimeout(() => input.classList.remove('error'), 2000);
          return;
        }

        // Validar formato (n√∫mero con letra opcional: 1, 1a, 2b, etc.)
        const pattern = /^\d+[a-z]?$/i;
        if (!pattern.test(category)) {
          input.classList.add('error');
          setToastStatus("‚ö†Ô∏è Formato inv√°lido. Usa: 1, 1a, 2, 3b, etc.", 'error');
          setTimeout(() => input.classList.remove('error'), 2000);
          return;
        }

        // Verificar duplicados
        if (categories.includes(category)) {
          input.classList.add('error');
          setToastStatus("‚ö†Ô∏è La categor√≠a '" + category + "' ya existe", 'error');
          setTimeout(() => input.classList.remove('error'), 2000);
          return;
        }

        categories.push(category);
        sortCategoriesLocal();
        input.value = '';
        input.focus();
        updateCategoriesList();
        setToastStatus("‚úì Categor√≠a agregada: " + category, 'success');
      }

      function removeCategory(index) {
        const removed = categories.splice(index, 1)[0];
        updateCategoriesList();
        setToastStatus("‚úì Categor√≠a eliminada: " + removed, 'success');
      }

      function sortCategoriesLocal() {
        categories.sort(function(a, b) {
          const matchA = a.match(/^(\d+)([a-z]?)$/i);
          const matchB = b.match(/^(\d+)([a-z]?)$/i);

          if (!matchA || !matchB) return 0;

          const numA = parseInt(matchA[1]);
          const numB = parseInt(matchB[1]);
          const letterA = matchA[2].toLowerCase();
          const letterB = matchB[2].toLowerCase();

          if (numA !== numB) return numA - numB;
          if (letterA < letterB) return -1;
          if (letterA > letterB) return 1;
          return 0;
        });
      }

      function updateCategoriesList() {
        const container = document.getElementById('categoriesList');

        if (categories.length === 0) {
          container.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; padding: 4px; width: 100%;">No hay categor√≠as agregadas</div>';
          return;
        }

        container.innerHTML = categories.map((cat, index) => {
          return `
            <span class="topic-tag">
              ${cat}
              <span class="remove-topic" onclick="removeCategory(${index})" title="Eliminar">√ó</span>
            </span>
          `;
        }).join('');
      }

      function autoNumberCategories() {
        const count = prompt("¬øCu√°ntas categor√≠as num√©ricas quieres generar? (ej: 10 generar√° 1, 2, 3... 10)");

        if (!count || isNaN(count) || parseInt(count) <= 0) {
          setToastStatus("‚ö†Ô∏è Ingresa un n√∫mero v√°lido", 'error');
          return;
        }

        const total = parseInt(count);
        categories = [];
        for (let i = 1; i <= total; i++) {
          categories.push(i.toString());
        }

        updateCategoriesList();
        setToastStatus("‚úì " + total + " categor√≠as generadas (1 a " + total + ")", 'success');
      }

      function clearCategories() {
        if (categories.length === 0) return;

        if (confirm('¬øEliminar todas las categor√≠as (' + categories.length + ')?')) {
          categories = [];
          updateCategoriesList();
          setToastStatus("‚úì Categor√≠as eliminadas", 'success');
        }
      }

      function generateAssignmentTable() {
        if (isProcessing) return;

        // Validaciones
        if (designers.length === 0) {
          setToastStatus("‚ö†Ô∏è Debes agregar al menos un dise√±ador", 'error');
          return;
        }

        if (categories.length === 0) {
          setToastStatus("‚ö†Ô∏è Debes agregar al menos una categor√≠a", 'error');
          return;
        }

        const piecesPerDesigner = parseInt(document.getElementById('piecesPerDesigner').value) || 0;
        if (piecesPerDesigner === 0) {
          setToastStatus("‚ö†Ô∏è Define cu√°ntas piezas hace cada dise√±ador", 'error');
          return;
        }

        const stillsCount = parseInt(document.getElementById('stillsCount').value) || 0;
        const conceptualsCount = piecesPerDesigner - stillsCount;

        if (stillsCount > piecesPerDesigner) {
          setToastStatus("‚ö†Ô∏è La cantidad de Stills no puede ser mayor que las piezas por dise√±ador", 'error');
          return;
        }

        const totalCapacity = designers.length * piecesPerDesigner;
        const totalCategories = categories.length;

        setProcessing(true);
        setToastStatus("‚è≥ Generando tabla de asignaci√≥n...");
        document.getElementById('logContainer').classList.add('visible');
        document.getElementById('toggleLogBtn').innerHTML = 'üìã Ocultar log detallado';
        updateLog("Generando tabla de asignaci√≥n...\nDise√±adores: " + designers.length + "\nPiezas por dise√±ador: " + piecesPerDesigner + "\nCategor√≠as totales: " + totalCategories + "\nStills (primeras): " + stillsCount + "\nConceptuales (restantes): " + conceptualsCount + "\nCapacidad total: " + totalCapacity);

        const assignmentData = {
          designers: designers,
          categories: categories,
          piecesPerDesigner: piecesPerDesigner,
          stillsCount: stillsCount
        };

        google.script.run
          .withSuccessHandler(function(result) {
            setProcessing(false);
            if (result && result.log) {
              updateLog(result.log);
            }
            if (result && result.success) {
              setToastStatus("‚úì Tabla de asignaci√≥n generada exitosamente", 'success');
            } else {
              setToastStatus("‚úó Error generando tabla: " + (result.error || "desconocido"), 'error');
            }
          })
          .withFailureHandler(function(error) {
            setProcessing(false);
            setToastStatus("‚úó Error: " + error.message, 'error');
            updateLog("ERROR CR√çTICO: " + error.message);
          })
          .generateTaskAssignmentTable(assignmentData);
      }

      // ========== FIN FUNCIONES ASIGNACIONES ==========

      // Inicializaci√≥n
      document.addEventListener('DOMContentLoaded', function() {
        // Auto-focus en el campo de folder ID
        document.getElementById('folderId').focus();

        // Inicializar listas de asignaciones
        updateDesignersList();
        updateCategoriesList();

        // Enter key handlers
        document.getElementById('designerName').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') addDesigner();
        });
        document.getElementById('categoryInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') addCategory();
        });
      });
    </script>
  </body>
</html>
